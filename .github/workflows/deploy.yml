name: Deploiement Automatique Multi-Env

# On dÃ©clenche le pipeline sur les modifications de 'main' ET 'develop'
on:
  push:
    branches: [ "main", "develop" ]

jobs:
  build:
    runs-on: self-hosted

    steps:
    # 1. RÃ©cupÃ©ration du code
    - uses: actions/checkout@v3

    # 2. INTÃ‰GRATION CONTINUE (CI) - Le Gardien
    # On garde notre test de sÃ©curitÃ©, il s'applique aux deux environnements !
    - name: Test de SÃ©curitÃ© (CI)
      run: |
        if grep -q "INTERDIT" index.html; then
          echo "â›” ERREUR : Contenu interdit dÃ©tectÃ© !"
          exit 1
        else
          echo "âœ… Test validÃ© : Code propre."
        fi

    # 3. DÃ‰PLOIEMENT CONTINU (CD) - CONDITIONNEL

    # CAS A : C'est la branche MAIN -> On envoie sur PROD (Port 8080)
    - name: DÃ©ploiement PROD
      if: github.ref == 'refs/heads/main'
      run: |
        # On s'assure que le dossier existe
        mkdir -p /var/www/prod
        cp index.html /var/www/prod/index.html
        echo "ðŸš€ DÃ©ployÃ© en PRODUCTION (Port 8080)"

    # CAS B : C'est la branche DEVELOP -> On envoie sur STAGING (Port 8081)
    - name: DÃ©ploiement STAGING
      if: github.ref == 'refs/heads/develop'
      run: |
        # On s'assure que le dossier existe
        mkdir -p /var/www/staging
        cp index.html /var/www/staging/index.html
        echo "ðŸ§ª DÃ©ployÃ© en STAGING (Port 8081)"