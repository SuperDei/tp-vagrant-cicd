name: Deploiement Automatique Multi-Env

on:
  push:
    branches: [ "main", "develop" ]

jobs:
  build:
    runs-on: self-hosted

    steps:
    # 1. RÃ©cupÃ©ration du code
    - uses: actions/checkout@v3

    # 2. TEST CI (SÃ©curitÃ©)
    - name: Test de SÃ©curitÃ© (CI)
      run: |
        if grep -q "INTERDIT" index.html; then
          echo "â›” ERREUR : Contenu interdit dÃ©tectÃ© !"
          exit 1
        else
          echo "âœ… Test validÃ© : Code propre."
        fi

    # 3. DÃ‰PLOIEMENT (CD)

    # Cas PROD (Main)
    - name: DÃ©ploiement PROD
      if: github.ref == 'refs/heads/main'
      run: |
        mkdir -p /var/www/prod
        cp index.html /var/www/prod/index.html
        echo "ENV_NAME=PRODUCTION (Port 8080)" >> $GITHUB_ENV

    # Cas STAGING (Develop)
    - name: DÃ©ploiement STAGING
      if: github.ref == 'refs/heads/develop'
      run: |
        mkdir -p /var/www/staging
        cp index.html /var/www/staging/index.html
        echo "ENV_NAME=STAGING (Port 8081)" >> $GITHUB_ENV

    # 4. NOTIFICATIONS DISCORD (La nouveautÃ©)

    # En cas de SUCCÃˆS
    - name: Notification Discord - SuccÃ¨s
      if: success()
      run: |
        curl -H "Content-Type: application/json" \
        -d "{\"content\": \"ğŸš€ **DÃ‰PLOIEMENT RÃ‰USSI !**\\n\\nğŸŒ **Environnement :** ${{ env.ENV_NAME }}\\nâœ… Le nouveau site est en ligne.\\nğŸ‘¤ *DÃ©clenchÃ© par : ${{ github.actor }}*\"}" \
        "${{ secrets.DISCORD_WEBHOOK }}"

    # En cas d'Ã‰CHEC (Bug ou mot interdit)
    - name: Notification Discord - Erreur
      if: failure()
      run: |
        curl -H "Content-Type: application/json" \
        -d "{\"content\": \"ğŸš¨ **Ã‰CHEC DU DÃ‰PLOIEMENT**\\n\\nâŒ Une erreur a bloquÃ© la mise Ã  jour.\\nğŸ‘‰ VÃ©rifiez les logs sur GitHub.\"}" \
        "${{ secrets.DISCORD_WEBHOOK }}"